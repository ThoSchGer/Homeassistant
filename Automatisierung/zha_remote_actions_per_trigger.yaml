blueprint:
  name: ZHA Remote – Universal (zha_event)
  description: >
    Universeller Blueprint für ZHA Remotes über zha_event.
    Funktioniert mit allen ZHA-Geräten, unabhängig von Device-Trigger-Support.
    Unterstützt Short Press, Long Press mit Loop und Release.
    Mode restart sorgt dafür, dass Long-Press-Loop bei Release stoppt.
  domain: automation
  source_url: https://github.com/ThoSchGer/Homeassistant/blob/main/Automatisierung/zha_remote_actions_per_trigger.yaml

  input:
    # ===== Geräteauswahl =====
    zha_device:
      name: ZHA Remote Gerät
      description: Das ZHA-Gerät (z.B. IKEA Tradfri, Philips Hue Remote)
      selector:
        device:
          integration: zha
          multiple: false
    
    # ===== Command Matching =====
    command_short_on:
      name: Command für Short ON
      description: ZHA command für kurzen Druck oben (z.B. "on", "toggle")
      default: "on"
      selector:
        text:
    
    command_short_off:
      name: Command für Short OFF
      description: ZHA command für kurzen Druck unten (z.B. "off", "toggle")
      default: "off"
      selector:
        text:
    
    command_long_up:
      name: Command für Long UP
      description: ZHA command für langen Druck oben (z.B. "move_with_on_off", "step_with_on_off")
      default: "move_with_on_off"
      selector:
        text:
    
    command_long_down:
      name: Command für Long DOWN
      description: ZHA command für langen Druck unten (z.B. "move", "step")
      default: "move"
      selector:
        text:
    
    command_release:
      name: Command für Release
      description: ZHA command für Loslassen (z.B. "stop", "stop_with_on_off")
      default: "stop"
      selector:
        text:

    # ===== Short Press Aktionen =====
    on_short_actions:
      name: Short Press ON (oben)
      description: Aktionen beim kurzen Drücken der oberen Taste
      default: []
      selector:
        action: {}

    off_short_actions:
      name: Short Press OFF (unten)
      description: Aktionen beim kurzen Drücken der unteren Taste
      default: []
      selector:
        action: {}

    # ===== Long Press UP Aktionen =====
    up_long_start_actions:
      name: Long Press UP – Start
      description: Wird einmalig beim Start des Long-Press oben ausgeführt
      default: []
      selector:
        action: {}

    up_long_loop_actions:
      name: Long Press UP – Loop
      description: Wird während des Long-Press oben wiederholt ausgeführt
      default: []
      selector:
        action: {}

    up_release_actions:
      name: Release UP
      description: Aktionen beim Loslassen der oberen Taste
      default: []
      selector:
        action: {}

    # ===== Long Press DOWN Aktionen =====
    down_long_start_actions:
      name: Long Press DOWN – Start
      description: Wird einmalig beim Start des Long-Press unten ausgeführt
      default: []
      selector:
        action: {}

    down_long_loop_actions:
      name: Long Press DOWN – Loop
      description: Wird während des Long-Press unten wiederholt ausgeführt
      default: []
      selector:
        action: {}

    down_release_actions:
      name: Release DOWN
      description: Aktionen beim Loslassen der unteren Taste
      default: []
      selector:
        action: {}

    # ===== Loop Konfiguration =====
    loop_enabled:
      name: Loop aktivieren
      description: Long-Press Aktionen wiederholt ausführen
      default: true
      selector:
        boolean: {}

    loop_delay_ms:
      name: Loop Intervall (ms)
      description: Verzögerung zwischen Loop-Wiederholungen
      default: 250
      selector:
        number:
          min: 50
          max: 2000
          step: 50
          unit_of_measurement: ms
          mode: slider

    loop_max_repeats:
      name: Maximale Loop-Wiederholungen
      description: Sicherheitsgrenze für Loop-Durchläufe
      default: 500
      selector:
        number:
          min: 1
          max: 2000
          step: 1
          mode: slider

mode: restart
max_exceeded: silent

trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: !input zha_device

variables:
  command: "{{ trigger.event.data.command }}"
  args: "{{ trigger.event.data.args | default([]) }}"

action:
  - choose:
      # === Short Press ON ===
      - conditions:
          - condition: template
            value_template: "{{ command == command_short_on }}"
        sequence: !input on_short_actions

      # === Short Press OFF ===
      - conditions:
          - condition: template
            value_template: "{{ command == command_short_off }}"
        sequence: !input off_short_actions

      # === Long Press UP ===
      - conditions:
          - condition: template
            value_template: "{{ command == command_long_up }}"
          - condition: template
            value_template: "{{ args | length > 0 and args[0] in [0, '0', 'MoveMode.Up'] }}"
        sequence:
          - sequence: !input up_long_start_actions
          - if:
              - condition: template
                value_template: "{{ loop_enabled }}"
            then:
              - repeat:
                  while:
                    - condition: template
                      value_template: "{{ repeat.index <= loop_max_repeats }}"
                  sequence:
                    - sequence: !input up_long_loop_actions
                    - delay:
                        milliseconds: !input loop_delay_ms
            else:
              - sequence: !input up_long_loop_actions

      # === Long Press DOWN ===
      - conditions:
          - condition: template
            value_template: "{{ command == command_long_down }}"
          - condition: template
            value_template: "{{ args | length > 0 and args[0] in [1, '1', 'MoveMode.Down'] }}"
        sequence:
          - sequence: !input down_long_start_actions
          - if:
              - condition: template
                value_template: "{{ loop_enabled }}"
            then:
              - repeat:
                  while:
                    - condition: template
                      value_template: "{{ repeat.index <= loop_max_repeats }}"
                  sequence:
                    - sequence: !input down_long_loop_actions
                    - delay:
                        milliseconds: !input loop_delay_ms
            else:
              - sequence: !input down_long_loop_actions

      # === Release (UP or DOWN) ===
      - conditions:
          - condition: template
            value_template: "{{ command == command_release }}"
        sequence:
          - choose:
              # Versuche zu erkennen ob UP oder DOWN basierend auf vorherigem Event
              # In der Praxis stoppt mode:restart die Loop automatisch
              - conditions:
                  - condition: template
                    value_template: "true"
                sequence: !input up_release_actions
            default: !input down_release_actions
